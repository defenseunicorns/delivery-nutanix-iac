# Postgres Profile VM module

This module stands up a VM that is preconfigured with all the settings required for the NDB service to import it for the purpose of creating a new Postgres database profile. It requires a VM image that has been built by the delivery-nutanix-image-builder repo that contains all the prerequisite software installed. An example set of variables passed to the module looks something like this:

```
nutanix_cluster     = "Your-Cluster"
nutanix_subnet      = "Your Subnet"
image_name          = "uds-postgresql-buildtag"
ssh_authorized_keys = ["Your SSH public key"]
user_password       = "$6$eqCKlTML5rIALmwB$6fyOlrTK9E353ofDISHuEJxqIZx8MYt.mQM.qfbeydQX/CGnz204AlmYg5VCZ8O/xLKJ34CkgV7hyoUno08N9."
pg_password         = "desired-postgres-user-password"
```

The image name should be an image available in the cluster that was built by the postgres-profile image builder. user_password is the password that will be configured for the `era` user which is used by NDB to connect to the instance. The hashed value can be generated by using the command `mkpasswd -m sha-512 -s` or `openssl passwd -6` and providing the desired password. pg_password is the password that will be set for the postgres user and is also used by the NDB service to import the database. The passwords can be anything and will not persist when NDB is used to provision new databases in the future since NDB lets you set passwords at database provision time.

When the postgres image being used has SELinux enabled (if using RHEL this is the default), the following is a required `Post Create Command` when provisioning a database with the profile:

```
sudo touch /.autorelabel
```

On the next reboot, this fixes SELinux labels that prevent the era_postgres service from running correctly and failing to start on future reboots. This is taken care of automatically when using the [ndb-pg-db module](./ndb-pg-db-module.md) in this repo to provision NDB databases.

After the VM is deployed, it can be registered with the NDB service and then imported as a new postgres instance profile version. Once the profile has successfully been created from the VM, the VM can safely be deleted and the profile can be used to deploy new postgres DBs using the NDB service.